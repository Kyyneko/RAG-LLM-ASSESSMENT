name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 72.61.215.190
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            cd /opt/RAG-LLM-ASSESSMENT
            
            # Pull latest code (try main, fallback to master)
            git pull origin main || git pull origin master || git pull
            
            # Try docker deployment with sudo
            if command -v docker &> /dev/null; then
              sudo docker compose down 2>/dev/null || true
              sudo docker compose up -d --build 2>/dev/null || echo "Docker not available, using gunicorn"
            fi
            
            # Fallback: restart gunicorn if docker failed
            if ! curl -sf http://127.0.0.1:5002/ > /dev/null; then
              pkill -f "gunicorn.*RAG-LLM" || true
              source /opt/RAG-LLM-ASSESSMENT/venv/bin/activate
              cd /opt/RAG-LLM-ASSESSMENT
              nohup gunicorn -w 2 -k gevent -b 0.0.0.0:5002 --timeout 300 main:create_app > /dev/null 2>&1 &
              sleep 5
            fi
            
            # Health check
            curl -f http://127.0.0.1:5002/ && echo "Deployment successful!"
